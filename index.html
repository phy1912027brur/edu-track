<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyFlow - Cloud Study Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        .sidebar-active { border-right: 4px solid #3b82f6; background: #eff6ff; color: #1d4ed8; }
        .loader { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #sidebar { transition: transform 0.3s ease-in-out; }
        @media (max-width: 768px) {
            #sidebar.hidden-mobile { transform: translateX(-100%); }
            #sidebar.visible-mobile { transform: translateX(0); }
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Auth Overlay -->
    <div id="auth-loading" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center p-6 text-center">
        <div id="loading-spinner" class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-12 w-12 mb-4"></div>
        <div id="login-ui" class="hidden max-w-sm w-full">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">StudyFlow</h1>
            <p class="text-slate-500 mb-8">Cloud-Synced Study Partner</p>
            
            <div id="domain-warning" class="hidden mb-6 p-4 bg-red-50 border border-red-100 rounded-xl text-red-600 text-sm text-left">
                <p class="font-bold mb-1"><i class="fas fa-exclamation-circle"></i> Action Required:</p>
                Add <code class="bg-red-100 px-1 rounded">edu-study-flow.vercel.app</code> to Firebase Authorized Domains.
            </div>

            <button id="google-login-btn" class="w-full flex items-center justify-center gap-3 bg-white border border-slate-200 px-6 py-4 rounded-xl font-semibold shadow-sm hover:bg-slate-50 transition-all mb-4">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" alt="Google">
                Sign in with Google
            </button>
            
            <button id="guest-login-btn" class="w-full text-slate-400 text-sm font-medium hover:text-slate-600 underline">
                Continue as Guest
            </button>
        </div>
        <p id="loading-text" class="text-slate-500 font-medium animate-pulse mt-4">Connecting to Cloud...</p>
    </div>

    <!-- App Container -->
    <div id="app" class="min-h-screen flex flex-col md:flex-row hidden">
        <aside id="sidebar" class="fixed md:relative inset-y-0 left-0 w-64 bg-white border-r border-slate-200 flex flex-col z-50 hidden-mobile md:translate-x-0">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
                        <i class="fas fa-graduation-cap"></i> StudyFlow
                    </h1>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <nav class="flex-1 p-4 space-y-1">
                <button onclick="switchView('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600 sidebar-active" id="nav-dashboard"><i class="fas fa-th-large w-5"></i> Dashboard</button>
                <button onclick="switchView('syllabus')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600" id="nav-syllabus"><i class="fas fa-book-open w-5"></i> Syllabus</button>
                <div id="admin-nav-section" class="hidden">
                    <button onclick="switchView('admin')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-slate-600" id="nav-admin"><i class="fas fa-user-shield w-5"></i> Admin Panel</button>
                </div>
            </nav>
            <div class="p-4 border-t border-slate-100">
                <div class="flex items-center gap-3 p-2 bg-slate-50 rounded-xl">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold" id="user-avatar">?</div>
                    <div class="flex-1 overflow-hidden">
                        <p id="user-name" class="text-sm font-semibold truncate">User</p>
                        <button onclick="handleLogout()" class="text-[10px] text-red-500 font-bold uppercase">Sign Out</button>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0">
            <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 sticky top-0 z-30">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="md:hidden text-slate-600"><i class="fas fa-bars"></i></button>
                    <select id="exam-selector" onchange="changeExam(this.value)" class="bg-slate-100 border-none rounded-lg px-3 py-1.5 text-sm font-bold text-blue-600">
                        <option value="BCS">BCS Preliminary</option>
                        <option value="BANK">Bank Job</option>
                    </select>
                </div>
                <div id="sync-indicator" class="flex items-center gap-2 px-3 py-1 bg-green-50 text-green-600 rounded-full text-xs font-bold">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-ping"></span> Live Cloud
                </div>
            </header>
            <div id="content-mount" class="p-6"></div>
        </main>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBa6VymrHj6CkaYOjBa060KKkAm4wqzNnY",
            authDomain: "studyflow-6cc46.firebaseapp.com",
            projectId: "studyflow-6cc46",
            storageBucket: "studyflow-6cc46.firebasestorage.app",
            messagingSenderId: "942824463700",
            appId: "1:942824463700:web:132870aeaf3a5fad52bcc1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // Admin UID setup
        const ADMIN_UID = "TjSs3uqfSvQWfYoxYFP6gsZupkC3";
        const appId = "studyflow-prod";

        let user = null;
        let userData = { progress: {}, mastery: {}, customSyllabus: {} };
        let currentView = 'dashboard';
        let currentExam = 'BCS';

        onAuthStateChanged(auth, (u) => {
            if (u) {
                user = u;
                document.getElementById('auth-loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                updateUI(u);
                syncData(u.uid);
            } else {
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('loading-text').classList.add('hidden');
                document.getElementById('login-ui').classList.remove('hidden');
            }
        });

        document.getElementById('google-login-btn').onclick = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                if (error.code === 'auth/unauthorized-domain') {
                    document.getElementById('domain-warning').classList.remove('hidden');
                }
            }
        };

        document.getElementById('guest-login-btn').onclick = () => signInAnonymously(auth);
        window.handleLogout = () => signOut(auth);

        async function syncData(uid) {
            const userRef = doc(db, 'artifacts', appId, 'users', uid, 'state', 'profile');
            onSnapshot(userRef, (snap) => {
                if (snap.exists()) {
                    userData = snap.data();
                    renderContent();
                } else {
                    setDoc(userRef, { progress: {}, mastery: {}, customSyllabus: {} });
                }
            });

            // Admin panel check
            if (uid === ADMIN_UID) {
                document.getElementById('admin-nav-section').classList.remove('hidden');
            }
        }

        function updateUI(u) {
            document.getElementById('user-name').textContent = u.displayName || 'Guest User';
            document.getElementById('user-avatar').textContent = (u.displayName || 'G').charAt(0);
        }

        window.switchView = (v) => { currentView = v; renderContent(); };
        window.changeExam = (v) => { currentExam = v; renderContent(); };

        function renderContent() {
            const mount = document.getElementById('content-mount');
            mount.innerHTML = '';

            if (currentView === 'dashboard') {
                mount.innerHTML = `<h2 class="text-2xl font-bold mb-4">স্বাগতম!</h2>
                <div class="bg-blue-600 p-8 rounded-3xl text-white shadow-xl">
                    <p class="opacity-80">Overall Progress (${currentExam})</p>
                    <h3 class="text-4xl font-black mt-2">আপনার পড়াশোনা শুরু করুন</h3>
                </div>`;
            } else if (currentView === 'syllabus') {
                const syllabusData = userData.customSyllabus?.[currentExam] || [];
                mount.innerHTML = `<h2 class="text-2xl font-bold mb-4">${currentExam} সিলেবাস</h2>
                <div class="space-y-4">
                    ${syllabusData.length === 0 ? '<p class="text-slate-400">কোনো সিলেবাস ডাটা পাওয়া যায়নি।</p>' : 
                        syllabusData.map(item => `
                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                            <h4 class="font-bold text-blue-600">${item.subject}</h4>
                            <p class="text-sm font-semibold text-slate-700">Chapter: ${item.chapter}</p>
                            <p class="text-xs text-slate-500">Topic: ${item.topic}</p>
                        </div>
                        `).join('')
                    }
                </div>`;
            } else if (currentView === 'admin') {
                mount.innerHTML = `
                <div class="bg-white p-8 rounded-2xl border shadow-sm max-w-lg">
                    <h2 class="text-xl font-bold mb-6 text-blue-600"><i class="fas fa-plus-circle mr-2"></i>সিলেবাস অ্যাড করুন</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Subject Name</label>
                            <input type="text" id="adm-subject" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500" placeholder="e.g. English">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Chapter Name</label>
                            <input type="text" id="adm-chapter" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500" placeholder="e.g. Parts of Speech">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Topic Name</label>
                            <input type="text" id="adm-topic" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-blue-500" placeholder="e.g. Noun & Pronoun">
                        </div>
                        <button onclick="addSyllabusToCloud()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all">
                            Save Topic
                        </button>
                    </div>
                </div>`;
            }
        }

        window.addSyllabusToCloud = async () => {
            const subject = document.getElementById('adm-subject').value;
            const chapter = document.getElementById('adm-chapter').value;
            const topic = document.getElementById('adm-topic').value;

            if (!subject || !chapter || !topic) {
                alert("Please fill all fields!");
                return;
            }

            const newEntry = { subject, chapter, topic, id: Date.now() };
            const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'state', 'profile');

            try {
                await updateDoc(userRef, {
                    [`customSyllabus.${currentExam}`]: arrayUnion(newEntry)
                });
                alert("Syllabus added successfully!");
                document.getElementById('adm-subject').value = '';
                document.getElementById('adm-chapter').value = '';
                document.getElementById('adm-topic').value = '';
            } catch (e) {
                console.error(e);
                alert("Failed to add syllabus.");
            }
        };

        window.toggleSidebar = () => {
            const s = document.getElementById('sidebar');
            s.classList.toggle('hidden-mobile');
            s.classList.toggle('visible-mobile');
        };

        renderContent();
    </script>
</body>
</html>
